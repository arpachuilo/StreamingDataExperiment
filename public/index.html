<!DOCTYPE html>
<head>
  <meta charset='utf-8'>
  <script src='/libs/d3.min.js'></script>
  <script src='/libs/moment.min.js'></script>
  <script src='/libs/moment-duration-format.js'></script>
  <script src='/libs/socket.io.js'></script>

  <script src='./scripts/util.js'></script>

  <script src='./scripts/StreamingChart.js'></script>
  <script src='./scripts/TimeControl.js'></script>
  <script src='./scripts/BarAggregation.js'></script>
  <script src='./scripts/HeatmapAggregation.js'></script>
  <script src='./scripts/DynamicCardGrid.js'></script>
  <!-- <script src='./scripts/CircularProxy.js'></script> -->
  <!-- <script src='./scripts/BoundingBoxProxy.js'></script> -->
  <script src='./scripts/LassoProxy.js'></script>
  <script src='./scripts/WholeScreenProxy.js'></script>
  <script src='./scripts/Tooltip.js'></script>

  <script src='./scripts/api.js'></script>
  <script src='./scripts/settings.js'></script>

  <link href='https://fonts.googleapis.com/css?family=Roboto' rel='stylesheet'>
  <link rel='stylesheet' href='https://cdnjs.cloudflare.com/ajax/libs/skeleton/2.0.4/skeleton.css'>
  <link rel='stylesheet' href='https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.7.0/css/font-awesome.css'>
  <link rel='stylesheet' href='style.css'>

  <title>Streaming Selection</title>
</head>

<body onresize='resize()'>
  <div id='root'>
    <div class='toprow row container'>
        <span>Aggregation: </span>
        <select id='aggregationValue' onchange='onAggregationChange()'>
          <option value='HeatmapAggregation'>Heatmap</option>
          <option value='BarAggregation'>Bar Chart</option>
        </select>
        <span>Y Value: </span>
        <select id='yValue' onchange='onYChange()'>
          <option value='followers'>Followers</option>
          <option value='following'>Following</option>
          <option value='rt_count'>Retweet Count</option>
          <option value='fav_count'>Favorite Count</option>
        </select>
        <span>Proxy Method: </span>
        <select id='proxyValue' onchange='onProxyChange()'>
          <option value='LassoProxy'>Lasso Proxy</option>
          <option value='WholeScreenProxy'>WholeScreen Proxy</option>
        </select>
    </div>

    <div class='row charts'>
      <div class='nine columns'>
        <div class='row u-full-width'>
          <div class='four columns'>
            <div id='AggregationChart'></div>
          </div>
          <div class='eight columns'>
            <div id='StreamingChart'></div>
          </div>
        </div>
        <div class='row u-full-width'>
          <div class='four columns'>&nbsp;</div>
          <div class='eight columns'>
            <div id='TimeControl'></div>
          </div>
        </div>
      </div>
      <div class='three columns'>
        <div id='list'></div>
      </div>
    </div>

  </div>

  <script>
    document.getElementById('list').style.maxHeight = window.innerHeight * .75 + 'px'
    function onAggregationChange () {
      streamChart.setAggregation(window[document.getElementById('aggregationValue').value](d3.select('#AggregationChart')))
    }

    function onYChange () {
      streamChart.y(document.getElementById('yValue').value)
    }

    function onProxyChange () {
      var fn = window[document.getElementById('proxyValue').value]
      streamChart.cursor(fn)
    }

    var data = []
    var selectedData = []

    var streamChart = StreamingChart(d3.select('#StreamingChart'))
      .x('time')
      .y('followers')
      .cursor(LassoProxy)
      .clickHandler(function (d, i) {
        if (!selectedData.includes(d)) {
          selectedData.unshift(d)
          dynamicTD
            .setData(selectedData)
            .update()
        }
      })
      .setAggregation(HeatmapAggregation(d3.select('#AggregationChart')))
      .setTimeControls(TimeControl(d3.select('#TimeControl')))
      .start()

    Redis.setStream(streamChart)

    var fn = function (el, id) {
      Redis.wrappedAdd('card_remove', {
        target: id
      })

      // Find index to remove
      var index = -1
      for (var i = 0; i < selectedData.length; i++) {
        if (selectedData[i].id === id) {
          index = i
          break
        }
      }

      if (index > -1) {
        selectedData.splice(index, 1);
        el.remove();
      }
    }

    var dynamicTD = DynamicCardGrid(document.getElementById('list'), fn)
      .setData(selectedData)
      .update()

    d3.json('./config.json', function (error, CONFIG) {
      if (CONFIG.LIVE_STREAM) {
        streamChart.setNow((new Date()).getTime())
        var socket = io.connect('http://localhost:8080')
        socket.on('tweet', function (d) {
          data.push(JSON.parse(d))
          streamChart.setData(data)
        })
      } else {
        d3.json('./data/text_output_2017-04-11_10-49-NationalPetDay.json', function (error, json) {
          // Make for easier access to vars . . .
          data = json

          var tStart = d3.min(data, function (d) {
            return +d.time
          })

          streamChart
            .setNow(tStart)
            .setData(data)
        })
      }
    })
  </script>
</body>
